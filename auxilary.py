import scipy.signal
import numpy as np
import pandas as pd
import sys

import scipy.io
import random
import scipy.sparse

class PreprocessingBlock:
    fs = 200
    h_ecg = np.array([-1.64812130000000e-06, -4.16586350000000e-06, 9.60899420000000e-06, 2.84086030000000e-05,
                      -1.17783580000000e-19, -6.80162360000000e-05, -5.92208690000000e-05, 8.02233760000000e-05,
                      0.000170705040000000, -5.08420240000000e-19, -0.000276673340000000, -0.000212405100000000,
                      0.000260490270000000, 0.000511293680000000, -1.26587940000000e-18, -0.000732284410000000,
                      -0.000535461320000000, 0.000629394490000000, 0.00118998730000000, -2.49331900000000e-18,
                      -0.00159963120000000, -0.00113828900000000, 0.00130518530000000, 0.00241221720000000,
                      -4.24249320000000e-18, -0.00311481900000000, -0.00217736040000000, 0.00245588330000000,
                      0.00447060940000000, -6.46155650000000e-18, -0.00562074840000000, -0.00388389020000000,
                      0.00433544370000000, 0.00782000580000000, -8.97073380000000e-18, -0.00969018910000000,
                      -0.00666134060000000, 0.00740901720000000, 0.0133387710000000, -1.14768840000000e-17,
                      -0.0165676230000000, -0.0114448320000000, 0.0128310980000000, 0.0233715530000000,
                      -1.36257800000000e-17, -0.0301614570000000, -0.0214589070000000, 0.0250260410000000,
                      0.0480761730000000, -1.50788070000000e-17, -0.0740777880000000, -0.0616188810000000,
                      0.0930492360000000, 0.302324960000000, 0.399998660000000, 0.302324960000000, 0.0930492360000000,
                      -0.0616188810000000, -0.0740777880000000, -1.50788070000000e-17, 0.0480761730000000,
                      0.0250260410000000, -0.0214589070000000, -0.0301614570000000, -1.36257800000000e-17,
                      0.0233715530000000, 0.0128310980000000, -0.0114448320000000, -0.0165676230000000,
                      -1.14768840000000e-17, 0.0133387710000000, 0.00740901720000000, -0.00666134060000000,
                      -0.00969018910000000, -8.97073380000000e-18, 0.00782000580000000, 0.00433544370000000,
                      -0.00388389020000000, -0.00562074840000000, -6.46155650000000e-18, 0.00447060940000000,
                      0.00245588330000000, -0.00217736040000000, -0.00311481900000000, -4.24249320000000e-18,
                      0.00241221720000000, 0.00130518530000000, -0.00113828900000000, -0.00159963120000000,
                      -2.49331900000000e-18, 0.00118998730000000, 0.000629394490000000, -0.000535461320000000,
                      -0.000732284410000000, -1.26587940000000e-18, 0.000511293680000000, 0.000260490270000000,
                      -0.000212405100000000, -0.000276673340000000, -5.08420240000000e-19, 0.000170705040000000,
                      8.02233760000000e-05, -5.92208690000000e-05, -6.80162360000000e-05, -1.17783580000000e-19,
                      2.84086030000000e-05, 9.60899420000000e-06, -4.16586350000000e-06, -1.64812130000000e-06])
    h_rip = np.array(
        [-1.51632893744379e-07, 5.94335391143536e-21, 1.39347399451465e-06, 3.54370718351424e-06, 3.96292888822197e-06,
         3.20527912954208e-20, -7.97307001275653e-06, -1.49353373820323e-05, -1.35632634865822e-05,
         -1.18081644809335e-20, 2.09007567850769e-05, 3.57583729538009e-05, 3.01821234498704e-05, -1.48064064339630e-19,
         -4.16345643861427e-05, -6.82423116957736e-05, -5.55170699632647e-05, 5.71623563508308e-19,
         7.21214523659037e-05, 0.000115321679099460, 9.17732635129142e-05, -1.42542065486165e-18, -0.000114832620459906,
         -0.000180683184337356, -0.000141694967647736, -2.17366977688802e-19, 0.000172791813812159,
         0.000268803909558556, 0.000208591491039182, -7.91177348877416e-19, -0.000249599994613751,
         -0.000384986009619797, -0.000296361975332070, 2.67808551035431e-18, 0.000349461971313815, 0.000535396758902034,
         0.000409525984699157, -1.37908440759463e-18, -0.000477223530796113, -0.000727127297886964,
         -0.000553270314386214, -1.23692346189230e-18, 0.000638431721514514, 0.000968289777239564, 0.000733527357218661,
         -2.17548355179611e-18, -0.000839436913049876, -0.00126818195641507, -0.000957107716668267,
         7.77971758808637e-18, 0.00108756440443288, 0.00163756280901074, 0.00123192127393486, -3.17557226035359e-18,
         -0.00139139802690540, -0.00208910620665826, -0.00156733981811672, -4.60826046289287e-18, 0.00176124280318605,
         0.00263813964371319, 0.00197478675715448, -4.34261573388255e-18, -0.00220987685975248, -0.00330384563218477,
         -0.00246869747701061, 1.80703653726600e-17, 0.00275378181002392, 0.00411123436356662, 0.00306810278034294,
         -5.60672770628985e-18, -0.00341519271243250, -0.00509445122580288, -0.00379930263129019, 6.24550846635692e-18,
         0.00422561692735090, 0.00630250797415998, 0.00470054676736230, -6.87039644274609e-18, -0.00523213768627297,
         -0.00780968238487862, -0.00583064633649612, 7.46679559397540e-18, 0.00650937394175160, 0.00973558888471794,
         0.00728590002676834, -8.02008013577946e-18, -0.00818395986566571, -0.0122871943324301, -0.00923639457036323,
         8.51614128937446e-18, 0.0104899639385595, 0.0158568702838113, 0.0120135558276587, -8.94192963178020e-18,
         -0.0139129618479842, -0.0212884944415604, -0.0163592904680471, 9.28596734849368e-18, 0.0196483738735452,
         0.0307820565641742, 0.0243393806741612, -9.53880592773005e-18, -0.0316310456747085, -0.0524163290955286,
         -0.0446408438991225, 9.69340731753352e-18, 0.0748008478720866, 0.158942176950142, 0.225003831704875,
         0.250000015048447, 0.225003831704875, 0.158942176950142, 0.0748008478720866, 9.69340731753352e-18,
         -0.0446408438991225, -0.0524163290955286, -0.0316310456747085, -9.53880592773005e-18, 0.0243393806741612,
         0.0307820565641742, 0.0196483738735452, 9.28596734849368e-18, -0.0163592904680471, -0.0212884944415604,
         -0.0139129618479842, -8.94192963178020e-18, 0.0120135558276587, 0.0158568702838113, 0.0104899639385595,
         8.51614128937446e-18, -0.00923639457036323, -0.0122871943324301, -0.00818395986566571, -8.02008013577946e-18,
         0.00728590002676834, 0.00973558888471794, 0.00650937394175160, 7.46679559397540e-18, -0.00583064633649612,
         -0.00780968238487862, -0.00523213768627297, -6.87039644274609e-18, 0.00470054676736230, 0.00630250797415998,
         0.00422561692735090, 6.24550846635692e-18, -0.00379930263129019, -0.00509445122580288, -0.00341519271243250,
         -5.60672770628985e-18, 0.00306810278034294, 0.00411123436356662, 0.00275378181002392, 1.80703653726600e-17,
         -0.00246869747701061, -0.00330384563218477, -0.00220987685975248, -4.34261573388255e-18, 0.00197478675715448,
         0.00263813964371319, 0.00176124280318605, -4.60826046289287e-18, -0.00156733981811672, -0.00208910620665826,
         -0.00139139802690540, -3.17557226035359e-18, 0.00123192127393486, 0.00163756280901074, 0.00108756440443288,
         7.77971758808637e-18, -0.000957107716668267, -0.00126818195641507, -0.000839436913049876,
         -2.17548355179611e-18, 0.000733527357218661, 0.000968289777239564, 0.000638431721514514, -1.23692346189230e-18,
         -0.000553270314386214, -0.000727127297886964, -0.000477223530796113, -1.37908440759463e-18,
         0.000409525984699157, 0.000535396758902034, 0.000349461971313815, 2.67808551035431e-18, -0.000296361975332070,
         -0.000384986009619797, -0.000249599994613751, -7.91177348877416e-19, 0.000208591491039182,
         0.000268803909558556, 0.000172791813812159, -2.17366977688802e-19, -0.000141694967647736,
         -0.000180683184337356, -0.000114832620459906, -1.42542065486165e-18, 9.17732635129142e-05,
         0.000115321679099460, 7.21214523659037e-05, 5.71623563508308e-19, -5.55170699632647e-05, -6.82423116957736e-05,
         -4.16345643861427e-05, -1.48064064339630e-19, 3.01821234498704e-05, 3.57583729538009e-05, 2.09007567850769e-05,
         -1.18081644809335e-20, -1.35632634865822e-05, -1.49353373820323e-05, -7.97307001275653e-06,
         3.20527912954208e-20, 3.96292888822197e-06, 3.54370718351424e-06, 1.39347399451465e-06, 5.94335391143536e-21,
         -1.51632893744379e-07])
    h_air = np.array(
        [5.33700840000000e-08, 1.38028100000000e-07, 1.27020600000000e-07, -1.14131900000000e-07, -7.12861250000000e-07,
         -1.77456860000000e-06, -3.36823690000000e-06, -5.51365990000000e-06, -8.17126700000000e-06,
         -1.12354350000000e-05, -1.45320330000000e-05, -1.78207440000000e-05, -2.08025010000000e-05,
         -2.31320570000000e-05, -2.44354780000000e-05, -2.43319820000000e-05, -2.24593030000000e-05,
         -1.85014280000000e-05, -1.22173540000000e-05, -3.46926380000000e-06, 7.75157220000000e-06,
         2.13029440000000e-05, 3.68756470000000e-05, 5.39848380000000e-05, 7.19702090000000e-05, 9.00060570000000e-05,
         0.000107121940000000, 0.000122234100000000, 0.000134187350000000, 0.000141806410000000, 0.000143955260000000,
         0.000139602260000000, 0.000127888570000000, 0.000108196480000000, 8.02143750000000e-05, 4.39945330000000e-05,
         -1.85622400000000e-19, -5.08631010000000e-05, -0.000107231150000000, -0.000167289300000000,
         -0.000228800520000000, -0.000289158680000000, -0.000345465720000000, -0.000394632040000000,
         -0.000433497830000000, -0.000458971820000000, -0.000468182960000000, -0.000458638990000000,
         -0.000428385500000000, -0.000376157790000000, -0.000301517920000000, -0.000204968870000000,
         -8.80382130000000e-05, 4.66757050000000e-05, 0.000195501060000000, 0.000353737840000000, 0.000515753970000000,
         0.000675132910000000, 0.000824871250000000, 0.000957622360000000, 0.00106597960000000, 0.00114279060000000,
         0.00118149100000000, 0.00117644570000000, 0.00112328300000000, 0.00101920550000000, 0.000863263650000000,
         0.000656575760000000, 0.000402479990000000, 0.000106606330000000, -0.000223141990000000, -0.000576704690000000,
         -0.000942081810000000, -0.00130565180000000, -0.00165258530000000, -0.00196734600000000, -0.00223426370000000,
         -0.00243816370000000, -0.00256502840000000, -0.00260266980000000, -0.00254138270000000, -0.00237455300000000,
         -0.00209919170000000, -0.00171636700000000, -0.00123150940000000, -0.000654568060000000, 1.33993260000000e-18,
         0.000713419300000000, 0.00146297050000000, 0.00222254900000000, 0.00296339930000000, 0.00365500970000000,
         0.00426614400000000, 0.00476598140000000, 0.00512532780000000, 0.00531785810000000, 0.00532134630000000,
         0.00511883430000000, 0.00469969490000000, 0.00406054150000000, 0.00320594230000000, 0.00214890060000000,
         0.000911071200000000, -0.000477313090000000, -0.00197781600000000, -0.00354447940000000, -0.00512480410000000,
         -0.00666101180000000, -0.00809155960000000, -0.00935286730000000, -0.0103812090000000, -0.0111147160000000,
         -0.0114954180000000, -0.0114712730000000, -0.0109981030000000, -0.0100413690000000, -0.00857773140000000,
         -0.00659632410000000, -0.00409969430000000, -0.00110436810000000, 0.00235899130000000, 0.00624585100000000,
         0.0104985050000000, 0.0150471870000000, 0.0198115880000000, 0.0247027140000000, 0.0296250690000000,
         0.0344790690000000, 0.0391636380000000, 0.0435788960000000, 0.0476288620000000, 0.0512240930000000,
         0.0542841590000000, 0.0567399010000000, 0.0585353780000000, 0.0596294550000000, 0.0599969690000000,
         0.0596294550000000, 0.0585353780000000, 0.0567399010000000, 0.0542841590000000, 0.0512240930000000,
         0.0476288620000000, 0.0435788960000000, 0.0391636380000000, 0.0344790690000000, 0.0296250690000000,
         0.0247027140000000, 0.0198115880000000, 0.0150471870000000, 0.0104985050000000, 0.00624585100000000,
         0.00235899130000000, -0.00110436810000000, -0.00409969430000000, -0.00659632410000000, -0.00857773140000000,
         -0.0100413690000000, -0.0109981030000000, -0.0114712730000000, -0.0114954180000000, -0.0111147160000000,
         -0.0103812090000000, -0.00935286730000000, -0.00809155960000000, -0.00666101180000000, -0.00512480410000000,
         -0.00354447940000000, -0.00197781600000000, -0.000477313090000000, 0.000911071200000000, 0.00214890060000000,
         0.00320594230000000, 0.00406054150000000, 0.00469969490000000, 0.00511883430000000, 0.00532134630000000,
         0.00531785810000000, 0.00512532780000000, 0.00476598140000000, 0.00426614400000000, 0.00365500970000000,
         0.00296339930000000, 0.00222254900000000, 0.00146297050000000, 0.000713419300000000, 1.33993260000000e-18,
         -0.000654568060000000, -0.00123150940000000, -0.00171636700000000, -0.00209919170000000, -0.00237455300000000,
         -0.00254138270000000, -0.00260266980000000, -0.00256502840000000, -0.00243816370000000, -0.00223426370000000,
         -0.00196734600000000, -0.00165258530000000, -0.00130565180000000, -0.000942081810000000, -0.000576704690000000,
         -0.000223141990000000, 0.000106606330000000, 0.000402479990000000, 0.000656575760000000, 0.000863263650000000,
         0.00101920550000000, 0.00112328300000000, 0.00117644570000000, 0.00118149100000000, 0.00114279060000000,
         0.00106597960000000, 0.000957622360000000, 0.000824871250000000, 0.000675132910000000, 0.000515753970000000,
         0.000353737840000000, 0.000195501060000000, 4.66757050000000e-05, -8.80382130000000e-05, -0.000204968870000000,
         -0.000301517920000000, -0.000376157790000000, -0.000428385500000000, -0.000458638990000000,
         -0.000468182960000000, -0.000458971820000000, -0.000433497830000000, -0.000394632040000000,
         -0.000345465720000000, -0.000289158680000000, -0.000228800520000000, -0.000167289300000000,
         -0.000107231150000000, -5.08631010000000e-05, -1.85622400000000e-19, 4.39945330000000e-05,
         8.02143750000000e-05, 0.000108196480000000, 0.000127888570000000, 0.000139602260000000, 0.000143955260000000,
         0.000141806410000000, 0.000134187350000000, 0.000122234100000000, 0.000107121940000000, 9.00060570000000e-05,
         7.19702090000000e-05, 5.39848380000000e-05, 3.68756470000000e-05, 2.13029440000000e-05, 7.75157220000000e-06,
         -3.46926380000000e-06, -1.22173540000000e-05, -1.85014280000000e-05, -2.24593030000000e-05,
         -2.43319820000000e-05, -2.44354780000000e-05, -2.31320570000000e-05, -2.08025010000000e-05,
         -1.78207440000000e-05, -1.45320330000000e-05, -1.12354350000000e-05, -8.17126700000000e-06,
         -5.51365990000000e-06, -3.36823690000000e-06, -1.77456860000000e-06, -7.12861250000000e-07,
         -1.14131900000000e-07, 1.27020600000000e-07, 1.38028100000000e-07, 5.33700840000000e-08])

    def __init__(self, energy_win_length):
        self.energy_win_length = energy_win_length
        self.delay_shift = energy_win_length // 2
        self.w = scipy.signal.hann(energy_win_length)
        self.w = self.w / self.w.sum()

    def do(self, sample, fname):
        e = scipy.signal.convolve(self.w, sample['AIRFLOW'].values ** 2)
        e[e<0] = 0
        e = np.sqrt(e[self.delay_shift:-self.delay_shift])
        sample['AIRFLOW'] = sample['AIRFLOW'].values / np.maximum(e, sys.float_info.epsilon)

        sample['ECG'] = scipy.signal.convolve(self.h_ecg, sample['ECG'].values)[
                        self.h_ecg.size // 2:-(self.h_ecg.size // 2)]
        sample['ABD'] = scipy.signal.convolve(self.h_rip, sample['ABD'].values)[
                        self.h_rip.size // 2:-(self.h_rip.size // 2)]
        sample['CHEST'] = scipy.signal.convolve(self.h_rip, sample['CHEST'].values)[
                          self.h_rip.size // 2:-(self.h_rip.size // 2)]

        qr = sample.iloc[:, np.in1d(sample.columns, ['SaO2', 'sleep_label', 'arousal_label', 'target_label'], invert=True)].quantile([0.25, 0.5, .75])

        # log for 0 iqr:
        tmp_idx = np.where((qr.iloc[2]-qr.iloc[0]) == 0)[0]
        if len(tmp_idx) > 0:
            for ti in tmp_idx:
                txt = 'iqr = 0 for file {}, signal: {}\n'.format(fname,sample.columns[ti])
                print(txt)
                with open("iqr_log.txt", "a") as logfile:
                    logfile.write(txt)

        sample.iloc[:, np.in1d(sample.columns, ['SaO2', 'sleep_label', 'arousal_label', 'target_label'], invert=True)] = (sample.iloc[:,
                                                                                   np.in1d(sample.columns,
                                                                                           ['SaO2', 'sleep_label', 'arousal_label', 'target_label'],
                                                                                           invert=True)] - qr.iloc[
                                                                                       1]) / (qr.iloc[2] - qr.iloc[
            0]).replace(0, 1)

        sample['AIRFLOW'] = scipy.signal.convolve(self.h_air, sample['AIRFLOW'].values)[
                            self.h_air.size // 2:-(self.h_air.size // 2)]

        s_valid_idx = sample['SaO2'] > 2
        if s_valid_idx[-1:].values[0] == False:
            tmp_idx = s_valid_idx[::-1].idxmax()
            sample['SaO2'][-1:] = sample['SaO2'][tmp_idx]
            s_valid_idx[-1:] = True

        time = np.linspace(0, (sample['SaO2'].size - 1) / self.fs, sample['SaO2'].size)
        time_s1 = s_valid_idx.to_numpy().nonzero()[0] / self.fs

        sample['SaO2'] = np.interp(time, time_s1, sample['SaO2'][s_valid_idx.to_numpy().nonzero()[0]])

        return sample